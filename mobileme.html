<!doctype html>
<html lang="en" class="no-js">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	
	<title>MobileMe Particles</title>
	<meta name="description" content="">
	<meta name="author" content="">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<link rel="stylesheet" href="css/reset.css">
	<style type="text/css" media="screen">
		body {
			background-image: -moz-linear-gradient(top, #040c3f, #040c3f 20%, #07368b 90%, #0057a6);
			background-image: -webkit-gradient(linear, center top, center bottom, from( #040c3f), color-stop(20%, #040c3f), color-stop(90%, #07368b), to( #0057a6)); 
			background-image: linear-gradient(top, #040c3f, #040c3f 20%, #07368b 90%, #0057a6);
			overflow: hidden;
		}
	#cloud{
		position: absolute;
		top: 50%;
		left: 50%;
		margin-left: -119px;
		margin-top: -115px;
		width: 238px;
		height: 156px;
		background: url(img/mm_cloud.png);
	}

	</style>

</head>
<body>

	<div id="cloud"></div>

	<script src="js/libs/jquery-1.5.1.min.js"></script>
	<script src="js/libs/modernizr-1.7.min.js"></script>
	<script src="js/util.js"></script>
	<script src="js/particle.js"></script>
	<script src="js/field.js"></script>

	<script> 

		// screen size variables
				SCREEN_WIDTH = window.innerWidth,
				SCREEN_HEIGHT = window.innerHeight,
				HALF_WIDTH = window.innerWidth / 2,
			  HALF_HEIGHT = window.innerHeight / 2;

		// canvas element and 2D context
		  	canvas = document.createElement( 'canvas' ),
				context = canvas.getContext( '2d' ),
				container = document.createElement( 'div' );

	  // Physix
		var TO_RADIANS = Math.PI/180,
				TO_DEGREES = 180/Math.PI;

		// Interaction
		var mouseX = 0,
				mouseY = 0,
				mouseSpeed = 0,
				mouseDown = false;

		// Particles
		var particles = [],
				particleImage = new Image(),
				NEW_PARTICLE_RATE = 1,
				MAX_PARTICLES = 600;

		particleImage.src = 'img/mm_particle.png'

		// Fields
		var fields = [],
				fieldSets = [],
				activeFieldSet = 0,
				fieldTimer = 0; // Used to script field events
				
		// The handling of field sets is not flexible at the moment. Refactor needed.
		// First field in the set is centered and keeps the particles in the center for a bit
		// before having it's mass reduced from 200 to 0. During that time, the 2nd and 3rd
		// fields in the field set have their mass increased from to 20 to 0. This process is then 
		// reversed and then the next fieldset is loaded.
		fieldSets.push([  new Field(HALF_WIDTH, HALF_HEIGHT, 150),
											new Field(SCREEN_WIDTH/5, HALF_HEIGHT, 0),
										  new Field(SCREEN_WIDTH - SCREEN_WIDTH/5, HALF_HEIGHT/2, 0)]);

		fieldSets.push([  new Field(HALF_WIDTH, HALF_HEIGHT, 150),
											new Field(SCREEN_WIDTH/5, HALF_HEIGHT/2, 0),
										  new Field(SCREEN_WIDTH - SCREEN_WIDTH/5, HALF_HEIGHT, 0)]);
				
		// Debugging
		var SHOW_FIELDS = false;
	
		/*
		*	Setup canvas and fields
		*/
		function init() {

			// Canvas html setup
			document.body.appendChild(container);
			container.appendChild(canvas); 
			canvas.width = SCREEN_WIDTH; 
			canvas.height = SCREEN_HEIGHT;

			// Create fields
		  fields = fieldSets[0].slice();

			// Set main loop to run at 30 fps
			setInterval(loop, 1000 / 30);
		
			// Setup interaction
			initMouseListeners(); 
		
		}


		/*
		*	Main loop for render and update calls. Also clearing out of dead particles.
		*/
		function loop() {	

			/* Debug field masses
			if(fieldTimer%30 == 0){
				console.log(fieldTimer + ' fields[1] ' + fields[1].mass);
				console.log('fields[1] ' + fields[1].mass);
				console.log('fields[2] ' + fields[2].mass);				
			}
*/
			fieldTimer++;
			
			/*
			* Script to control the rate of particle creation and strength of fields.
			*/
			if(fieldTimer == 1){
				fields[0].mass = 150;
				fields[1].mass = fields[2].mass = 0;
				if(fieldTimer%2 == 0){
					makeParticle(1);
				}
			} else if(fieldTimer < 100){
					fields[0].mass -=1.5;
					fields[1].mass = fields[2].mass += .25;
					makeParticle(1);
			} else if(fieldTimer < 250){
					fields[1].mass = fields[2].mass += .5;
					makeParticle(2);
			} else if(fieldTimer < 400){
					fields[0].mass += .33;
					fields[1].mass = fields[2].mass += 2;
			} else if(fieldTimer < 500){
					fields[0].mass += 1;
					fields[1].mass = fields[2].mass -= 3.8;
					makeParticle(1);
			} else if(fieldTimer = 550){
	 		 		toggleFieldSet();
					fieldTimer = 0;
			}

			// clear the canvas
			context.clearRect(0,0, SCREEN_WIDTH, SCREEN_HEIGHT);

			// Make fields visible. For debugging.
			if(SHOW_FIELDS){
				for (i=0; i<fields.length; i++) {
					var field = fields[i];
					field.render(context);
				}
			}

			// Check particle lifespans in loop. If dead, remove from array. 
			// Keep track of # removed because array will be shifting around.
			var deadParticleCount = 0;
		  
			// iteratate through each particle
			for (i=0; i<particles.length; i++) {
				
				var particle = particles[i - deadParticleCount]; 

				// render it
				particle.render(context); 

				// and then update. We always render first so particle
				// appears in the starting point.
				particle.update();

				// Remove dead particle from array
				if(particle.lifespan == 0){
					particles.splice(i,1);
					deadParticleCount++;
				}
			}	
		
			// Keep taking the oldest particles away until we have 
			// fewer than the maximum allowed. 
			while(particles.length>MAX_PARTICLES){
				particles.shift();
			}
		}

	
	
		function makeParticle(particleCount) {

			for(var i=0; i<particleCount;i++) {

					// create a new particle in the middle of the stage
					var particle = new Particle(HALF_WIDTH, HALF_HEIGHT, particleImage); 

					// give it a random x and y velocity
					particle.velX = randomRange(-2,2);
					particle.velY = randomRange(-1.5,.25);
					particle.size = randomRange(.1,1.4);
					particle.gravity = 0; 
					particle.drag = 0.999;
					particle.shrink = 0.99; 
					particle.alpha = .7; 
					particle.fade = 0.0015; 
					// sets the blend mode so particles are drawn with an additive blend
					particle.compositeOperation = 'lighter';

					// add it to the array
					particles.push(particle);

			}
		}

		function initMouseListeners() {
			$(document).bind('mousemove', onMouseMove);
			$(document).bind('mousedown', onMouseDown, false );
			$(document).bind('mouseup', onMouseUp, false );
		}

		function onMouseMove(e) {
			e.preventDefault();
//			xDiff = mouseX - e.clientX;
//			yDiff = mouseY - e.clientY;
//			mouseSpeed = Math.sqrt( Math.pow(xDiff,2) + Math.pow(yDiff,2));			
			mouseX = e.clientX;
			mouseY = e.clientY;
		}
	
		function onMouseDown(e) {
			mouseDown = true; 
		}
		function onMouseUp(e) {
			mouseDown = false; 
		}

		function toggleFieldSet(){
			activeFieldSet = (activeFieldSet == 0)? 1: 0;
		  fields = fieldSets[activeFieldSet].slice();
		}

	 	$(document).ready(function(){

			init();

   });
	
	</script> 

	
</body>
</html>